<div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
        <#include "/apps/business/contacts/include/left.html">
    </div>
</div>

<div class="layui-body">
    <div class="layui-side-scroll">
        <div class="box-header">
            <h1 class="site-h1" style="background-color:#FFFFFF;">
                <span class="ukefu-bt">
                <i class="layui-icon ukewo-btn" style="font-size:20px;text-align: center;">&#xe612;</i>
                联系人详情
                </span>
            </h1>
            <div class="row">
                <div class="col-lg-6">
                    <div class="box-body ukefu-im-theme">
                        <div class="uk-layui-form">
                            <input hidden value="${contacts.id!''}" id="contactsId"/>
                            <div class="layui-collapse">
                                <div class="layui-colla-item">
                                    <h2 class="layui-colla-title">基本信息</h2>
                                    <div class="layui-colla-content layui-show">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">获得时间：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    <#if contacts.touchtime??>${contacts.touchtime?string('yyyy-MM-dd')}</#if>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">类型：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    ${uKeFuDic[contacts.ckind!''].name!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">共享联系人：</label>
                                                <div class="layui-input-inline" style="width:auto; line-height: 2.5em;">
                                                    <#if contacts?? && contacts.shares?? && contacts.shares == 'none'>
                                                        不共享（仅创建人和直属上级可见）
                                                    <#elseif contacts?? && contacts.shares?? && contacts.shares == 'all'>
                                                        所有人
                                                    </#if>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-colla-item">
                                    <h2 class="layui-colla-title">联系人信息</h2>
                                    <div class="layui-colla-content layui-show">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label" id="cusname">联系人名称：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    ${contacts.name!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">性别：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    <#if contacts.gender?? && contacts.gender == '1'>男</#if>
                                                    <#if contacts.gender?? && contacts.gender == '0'>女</#if>
                                                    <#if contacts.gender?? && contacts.gender == '-1'>未知</#if>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">生日：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    ${contacts.birthday!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">联系电话：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    ${contacts.phone!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">手机号：</label>
                                                <div class="layui-input-inline" style="line-height: 2.5em;">
                                                    ${contacts.mobileno!''}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">城市：</label>
                                                <div class="layui-input-inline" style="width:80px;line-height: 2.5em;">
                                                    ${uKeFuDic[contacts.province!''].name!''}
                                                </div>
                                            </div>
                                            <div class="layui-inline">
                                                <div class="layui-input-inline" style="width:80px; line-height: 2.5em;" id="contacts_city">
                                                    ${uKeFuDic[contacts.city!''].name!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">电子邮件：</label>
                                                <div class="layui-input-inline" style="margin-left:5px;line-height: 2.5em;">
                                                    ${contacts.email!''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">联系人地址：</label>
                                                <div class="layui-input-inline" style="width: 159%;">
                                                    <input type="text" name="address" readonly value="${contacts.address!''}" class="layui-input">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">联系人说明：</label>
                                                <div class="layui-input-inline" style="width: 149%;">
                                                    <textarea name="memo" class="layui-textarea" readonly>${contacts.memo!''}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-body ukefu-im-theme" style="margin-top: 20px;">
                        <div class="uk-layui-form">
                            <div class="layui-collapse">
                                <h2 class="layui-colla-title">笔记</h2>
                                <div class="layui-colla-content layui-show">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="text-align: left;">笔记分类：</label>
                                        <div class="layui-input-inline">
                                            <select id="notesCategory" name="notesCategory" lay-filter="category" required lay-verify="required" style="display: inline">
                                                <option value="callout">外呼</option>
                                                <option value="callin">呼入</option>
                                                <option value="webim">WebIM</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="text-align: left;">内容：</label>
                                            <div class="layui-input-inline" style="width: 149%;">
                                                <textarea id="notesContent" name="notes" class="layui-textarea" ></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-button-inline" style="float: right;">
                                            <button class="layui-btn" lay-submit lay-filter="notesbtn" id="notesAddBtn">立即添加</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6" style="padding-left: 10px;">
                    <div class="layui-collapse">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">往来历史</h2>
                            <div class="layui-colla-content layui-show">
                                <div id="timeline" class="timeline-container" type="text" style="height: 1060px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>

    </div>
</div>
<link rel="stylesheet" href="/js/timelineMe/jquery.timelineMe.css" type="text/css">
<script type="text/javascript" src="/js/timelineMe/jquery.timelineMe.js"></script>
<script src="/js/jquery.cookie.min.js"></script>
<script>
    function httpRequest(opts) {
        var localUrl = 'http://localhost:8035';
        var devUrl = 'http://47.104.19.187:8035';
        var proUrl = 'http://pro';

        var postfix = '/api/';

        var urlPath = opts.path || '';
        var query = opts.query || '';

        var apiHost = window.location.origin;

        var payload = {};
        payload.url = apiHost + postfix + urlPath + query;
        payload.method = payload.method || 'POST';
        payload.contentType = 'application/json;charset=UTF-8';
        payload.headers = {
            authorization: $.cookie('authorization')
        };
        payload.dataType = 'json';

        payload.data = JSON.stringify(opts.data);

        return new Promise(function(resolve, reject) {
            $.ajax(payload)
                .done(function (data) {
                    console.log('Rest api 返回的值：', data);
                    resolve(data);
                })
                .fail(function (jqXHR, textStatus ) {
                    console.error('Rest api 返回error：', jqXHR);
                    reject(jqXHR)
                });
        });
    }

    // save time line datas
    var items = [];

    function getNotesByContactId () {
        // 获取数据
        var id = $('#contactsId').val();
        var payload = {
            path: 'contacts/notes',
            data: { ops: "fetch", contactid: id },
        };
        httpRequest(payload).then(function (data) {
            // remove a click event and set color to gray
            // AUTH_ERROR
            if(data.status && data.status === "AUTH_ERROR"){
                return;
            }

            if(data.rc === 0){
                // var items = [];
                if(data.totalElements > 0) {
                    for(var item of data.data){
                        items.push({
                            type: 'bigItem',
                            label: item.updatetime,
                            picto: '<div style="background-color: #3ac3e8;width: 100%;height: 100%;"></div>',
                            shortContent: '<div style="border: solid 1px #333333; line-height: 2em;font-weight: 300;word-break:break-all"><p>事件类型：' + item.category + '</p>' + '<p>创建者:' + item.creatername + '</p>' + '<div><label>内容：</label><span>' + item.content + '</span></div></div>',
                            forcePosition: 'right'
                        });
                    }
                }
                // time line
                makeTimeline()
            } else {
            }
        }, function (err) {
            console.log(err)
        });
    }

    // make time line
    function makeTimeline() {
        var el = $('#timeline');
        if(el){
            $(el).empty();
            $('#timeline').timelineMe({});
            $('#timeline').timelineMe('load',
                items
            );
        } else  {
            $('#timeline').timelineMe({
                items: items,
            });
        }
    }

    $(document).ready(function () {

        // get all notes by contact id.
        getNotesByContactId();

        $('#notesAddBtn').on('click', function(){
            var content = $('#notesContent').val() || '';
            if(!content) return;

            var id = $('#contactsId').val();
            var category = $("#notesCategory option:selected").text();

            var payload = {
                path: 'contacts/notes',
                data: {
                    ops: "create",
                    contactid: id,
                    category: category,
                    content: content,
                    agentuser: '',
                    onlineuser: ''
                },
            };
            httpRequest(payload).then(function (data) {
                if(data.status && data.status === "AUTH_ERROR"){
                    return;
                }

                if(data.rc === 0){
                    var item = data.data;
                    // get all notes by contact id.
                    items.unshift({
                        type: 'bigItem',
                        label: item.updatetime,
                        picto: '<div style="background-color: #3ac3e8;width: 100%;height: 100%;"></div>',
                        shortContent: '<div style="border: solid 1px #333333; line-height: 2em;font-weight: 300;word-break:break-all"><p>事件类型：' + category + '</p>' + '<p>创建者:' + item.creatername + '</p>' + '<div><label>内容：</label><span>' + content + '</span></div></div>',
                        forcePosition: 'right'
                    });

                    // time line
                    makeTimeline()
                } else {
                }
            }, function (err) {
                console.log(err)
            });
        });
    });
</script>

